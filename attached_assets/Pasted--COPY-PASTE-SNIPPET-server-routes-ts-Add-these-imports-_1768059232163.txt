// COPY/PASTE SNIPPET: server/routes.ts
// Add these imports near the top:
import {
  coerceEvidenceType,
  makeAtomId,
  makeContentHash,
  persistEvidenceAtoms,
} from "./src/services/evidenceStore";

// Then REPLACE your existing POST /api/evidence/upload handler with this:
app.post("/api/evidence/upload", async (req, res) => {
  try {
    const db = req.app.locals.db;

    const {
      psurCaseId,
      psurRef,
      deviceCode,
      periodStart,
      periodEnd,
      evidence_type,
      normalizedRows, // IMPORTANT: your client should send normalized rows here
      uploadId,
      sourceFile,
    } = req.body;

    if (!psurCaseId || !psurRef || !deviceCode || !periodStart || !periodEnd) {
      return res.status(400).json({
        error: "Missing required fields: psurCaseId, psurRef, deviceCode, periodStart, periodEnd",
      });
    }
    if (!evidence_type) {
      return res.status(400).json({ error: "Missing required field: evidence_type" });
    }
    if (!Array.isArray(normalizedRows) || normalizedRows.length === 0) {
      return res.status(400).json({ error: "Missing required field: normalizedRows (non-empty array)" });
    }

    const evidenceType = coerceEvidenceType(evidence_type);
    const uploadedAt = new Date().toISOString();

    const atoms = normalizedRows.map((normalizedData: any) => {
      const atomId = makeAtomId(evidenceType, normalizedData);
      const contentHash = makeContentHash(normalizedData);

      return {
        atomId,
        evidenceType,
        contentHash,
        normalizedData,
        provenance: {
          uploadId: Number(uploadId ?? 0),
          sourceFile: String(sourceFile ?? "upload"),
          uploadedAt,
          deviceRef: { deviceCode },
          psurPeriod: { periodStart, periodEnd },
          extractDate: uploadedAt.slice(0, 10),
        },
      };
    });

    await persistEvidenceAtoms({
      db,
      psurCaseId: Number(psurCaseId),
      psurRef: String(psurRef),
      deviceCode: String(deviceCode),
      periodStart: String(periodStart),
      periodEnd: String(periodEnd),
      atoms,
    });

    return res.json({
      ok: true,
      evidenceType,
      atomCount: atoms.length,
      sampleAtom: atoms[0],
    });
  } catch (e: any) {
    return res.status(400).json({ error: e?.message || "Upload failed" });
  }
});