// FILE: server/services/templateLoader.ts
// Replace the entire file with this.

import fs from "fs";
import path from "path";

type HttpError = Error & { status?: number };

function makeHttpError(status: number, message: string): HttpError {
  const err: HttpError = new Error(message);
  err.status = status;
  return err;
}

// Canonical template IDs (single source of truth)
const TEMPLATE_ALIASES: Record<string, string> = {
  // UI-friendly aliases -> real template IDs
  "MDCG_2022_21": "MDCG_2022_21_ANNEX_I",
  "MDCG_2022_21_ANNEX_I": "MDCG_2022_21_ANNEX_I",
  "FormQAR-054_C": "FormQAR-054_C",
};

// Resolve templates directory robustly in Replit (no process.cwd() pitfalls)
function templatesDir(): string {
  // this file is server/services/templateLoader.ts
  // templates live in server/templates
  return path.resolve(__dirname, "..", "templates");
}

export function loadTemplate(templateIdRaw: string) {
  const templateId = (templateIdRaw || "").trim();
  if (!templateId) {
    throw makeHttpError(400, "templateId is required.");
  }

  const canonicalId = TEMPLATE_ALIASES[templateId] || templateId;

  const dir = templatesDir();
  const filePath = path.join(dir, `${canonicalId}.json`);

  if (!fs.existsSync(filePath)) {
    throw makeHttpError(
      400,
      `Template '${templateId}' not found. Looked for '${canonicalId}.json' in ${dir}`
    );
  }

  const raw = fs.readFileSync(filePath, "utf8");
  let parsed: any;
  try {
    parsed = JSON.parse(raw);
  } catch (e: any) {
    throw makeHttpError(500, `Template '${canonicalId}' JSON parse error: ${e?.message || e}`);
  }

  // Strict validation of template shape
  if (!parsed.template_id || typeof parsed.template_id !== "string") {
    throw makeHttpError(500, `Template '${canonicalId}' missing template_id.`);
  }
  if (!Array.isArray(parsed.slots)) {
    throw makeHttpError(500, `Template '${canonicalId}' slots must be an array.`);
  }
  if (!parsed.mapping || typeof parsed.mapping !== "object") {
    throw makeHttpError(500, `Template '${canonicalId}' mapping must be an object.`);
  }

  // Enforce ID consistency
  if (parsed.template_id !== canonicalId) {
    throw makeHttpError(
      500,
      `Template ID mismatch: file '${canonicalId}.json' contains template_id '${parsed.template_id}'.`
    );
  }

  return parsed;
}
