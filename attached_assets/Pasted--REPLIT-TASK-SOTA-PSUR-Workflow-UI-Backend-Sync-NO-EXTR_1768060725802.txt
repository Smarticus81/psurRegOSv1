# REPLIT TASK: SOTA PSUR Workflow UI + Backend Sync (NO EXTRA UI)

## Goal
Rebuild the UI so it is perfectly synchronized with the backend 8-step orchestrator workflow. Remove any UI components/tabs that are not part of the workflow. The UI must render ONLY what the backend returns (no guessing, no fake progress).

---

## Non-Negotiable Rules
1) The UI must be a SINGLE SCREEN with 3 panels:
   - Left: Scope + Create Case
   - Center: 8-step Stepper + Execution Log + per-step status
   - Right: Evidence Upload + Coverage Summary
2) Remove these UI tabs/pages if they exist: Queue, Output, Traces, Review, Upload History, Evidence Atoms, Coverage (as separate tabs).
   - All of that must be embedded in the single screen as drill-down sections.
3) The UI must never display “ACCEPTED” counts unless they come from the backend adjudication report.
4) Evidence must be explicitly linked to the case, and UI must show:
   - Uploaded atoms count
   - Rejected rows count + sample errors
   - LINKED TO CASE atoms count (critical)
   If linked count is 0, UI must show a blocking warning: "Evidence not attached to case."
5) The backend must expose a single canonical workflow result object that UI renders from.
   - No separate UI calls that create their own narrative. One source of truth.

---

## Backend: Required API Contract
Create/confirm endpoint:
POST /api/orchestrator/run

It must return a single JSON object like:

{
  "scope": {
    "templateId": "FormQAR-054_C" | "MDCG_2022_21_ANNEX_I",
    "jurisdictions": ["EU_MDR","UK_MDR"],
    "deviceCode": "JS3000X",
    "periodStart": "YYYY-MM-DD",
    "periodEnd": "YYYY-MM-DD"
  },
  "case": {
    "psurCaseId": number,
    "psurRef": string,
    "version": number
  },
  "steps": [
    {
      "step": 1,
      "name": "Qualify Template",
      "status": "NOT_STARTED"|"RUNNING"|"COMPLETED"|"FAILED",
      "startedAt": ISOString,
      "endedAt": ISOString,
      "summary": { ...small counts/flags... },
      "report": { ...full payload... }
    },
    ...
    {
      "step": 8,
      "name": "Export Bundle",
      "status": "...",
      "summary": {
        "bundleFiles": ["trace.jsonl","coverage_report.json","evidence_register.json","qualification_report.json","psur.docx|psur.md|psur.pdf"]
      },
      "report": { "downloadUrl": "... or file ids ..." }
    }
  ],
  "kernelStatus": {
    "euObligations": number,
    "ukObligations": number,
    "constraints": number,
    "templateSlots": number
  }
}

Also create/confirm:
GET /api/orchestrator/cases/:psurCaseId
- returns the latest canonical object for an existing case so UI can refresh and stay synced.

IMPORTANT: Step 3 (Ingest Evidence) report MUST include:
{
  "uploadedAtoms": number,
  "linkedToCaseAtoms": number,
  "rejectedRows": number,
  "sampleErrors": [...]
}

IMPORTANT: Step 6 (Adjudicate) report MUST include:
{
  "acceptedCount": number,
  "rejectedCount": number,
  "acceptedProposalIds": [...],
  "rejected": [{proposalId, reasons...}]
}

---

## Backend: Fix Evidence→Case Linking (Root Cause of “0 evidence atoms found”)
In Step 3 ingestEvidence.ts:
- Ensure that after atoms are created/normalized, they are linked to psurCaseId.
- listEvidenceAtomsByCase(psurCaseId) MUST return those atoms.
- If you currently store atoms without case linkage, add a join table or a psurCaseId foreign key field.
- Determinism requirement: linking must be deterministic and based only on scope + upload + filters.

---

## Backend: Proposal Validity Requirements (No More Schema Failures)
In proposeSlots.ts:
- Each SlotProposal MUST include:
  - evidenceAtomIds: array length >= 1 (only atoms linked to this case)
  - claimedObligationIds: array length >= 1 (from template slot mapping)
  - methodStatement: length >= 10
If no evidence exists for a slot, DO NOT fake it:
- Mark proposal as "BLOCKED_MISSING_EVIDENCE" and keep it out of adjudication acceptance.
- The UI must then show Step 4/5 blocked, not green.

---

## UI: Single Screen Layout (No Tabs)
Create/modify page: client/src/pages/psur.tsx (or your existing main workflow page)
Layout:

LEFT PANEL: "Scope"
- Template dropdown (FormQAR-054_C, MDCG_2022_21_ANNEX_I)
- Jurisdictions toggle (EU_MDR, UK_MDR)
- Device dropdown/select
- Period start/end
- Button: "Create Case" (calls orchestrator run with Step 1-2 only OR a dedicated create-case endpoint)
After created: show Case ID + Ref, lock scope inputs.

CENTER PANEL: "Workflow"
- 8-step vertical stepper
- Each step shows: status pill + 1-line summary (counts)
- Expand/collapse to view report JSON for that step
- Button: "Run Workflow" (calls POST /api/orchestrator/run for full 8 steps)
- Execution log should render directly from steps[].report/logs returned by backend, not client-generated strings.

RIGHT PANEL: "Evidence + Coverage"
Evidence Card:
- Evidence Type dropdown MUST use backend supported types exactly:
  - sales_volume
  - complaint_record
- Upload file control
- Button: "Analyze/Upload"
- Show results:
  - Uploaded atoms
  - Rejected rows + top sampleErrors
  - Linked to case atoms (MUST be >0 or show blocking warning)

Coverage Card:
- Obligations satisfied X/Y from backend coverage report
- Slots filled X/Y
- Missing evidence types list (if any)

BOTTOM: "Download Bundle"
- Only appears when Step 8 completed
- One button: "Download Audit Bundle"

---

## Remove These UI Elements Entirely
- Separate tabs: Queue / Output / Traces / Review
- Upload History page
- Evidence Atoms page
- Any “progress” indicators not backed by backend step status
- Any acceptance/coverage numbers not sourced from backend reports

---

## Acceptance Criteria
1) Running workflow with uploaded evidence shows linkedToCaseAtoms > 0.
2) If linkedToCaseAtoms = 0, Step 4+ cannot be marked complete, UI shows BLOCKED.
3) AcceptedCount shown in UI equals backend adjudication acceptedCount.
4) No UI tabs beyond the single workflow screen.
5) Every UI field is part of the workflow (scope, evidence, stepper, coverage, download). Nothing else.

Deliver by implementing both backend contract + UI changes. No optional extras.