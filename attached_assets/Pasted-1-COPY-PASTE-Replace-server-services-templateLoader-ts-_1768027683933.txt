1) COPY/PASTE: Replace server/services/templateLoader.ts
// FILE: server/services/templateLoader.ts
// Replace the entire file with this exact content.

import fs from "fs";
import path from "path";

type HttpError = Error & { status?: number };

function httpError(status: number, message: string): HttpError {
  const err: HttpError = new Error(message);
  err.status = status;
  return err;
}

// Aliases so UI can pass shorter ids
const TEMPLATE_ALIASES: Record<string, string> = {
  "MDCG_2022_21": "MDCG_2022_21_ANNEX_I",
  "MDCG_2022_21_ANNEX_I": "MDCG_2022_21_ANNEX_I",
  "FormQAR-054_C": "FormQAR-054_C",
};

function candidateTemplateDirs(): string[] {
  const dirs = new Set<string>();

  // IMPORTANT: these cover dev + dist builds in Replit
  dirs.add(path.resolve(__dirname, "..", "templates"));                 // server/templates OR dist/templates
  dirs.add(path.resolve(__dirname, "..", "..", "server", "templates")); // dist -> server/templates
  dirs.add(path.resolve(process.cwd(), "server", "templates"));         // cwd -> server/templates
  dirs.add(path.resolve(process.cwd(), "templates"));                   // cwd -> templates (fallback)

  return Array.from(dirs);
}

function findTemplatePath(canonicalId: string) {
  const tried: string[] = [];
  for (const dir of candidateTemplateDirs()) {
    const p = path.join(dir, `${canonicalId}.json`);
    tried.push(p);
    if (fs.existsSync(p)) return { found: p, tried };
  }
  return { found: null as string | null, tried };
}

export function loadTemplate(templateIdRaw: string) {
  const templateId = (templateIdRaw || "").trim();
  if (!templateId) throw httpError(400, "templateId is required.");

  const canonicalId = TEMPLATE_ALIASES[templateId] || templateId;

  const { found, tried } = findTemplatePath(canonicalId);

  // LOGS YOU WILL SEE IN REPLIT CONSOLE
  console.log("[TemplateLoader] templateIdRaw =", templateIdRaw);
  console.log("[TemplateLoader] canonicalId   =", canonicalId);
  console.log("[TemplateLoader] cwd           =", process.cwd());
  console.log("[TemplateLoader] __dirname     =", __dirname);
  console.log("[TemplateLoader] searched:");
  tried.forEach(p => console.log(" -", p, fs.existsSync(p) ? "(FOUND)" : ""));

  if (!found) {
    throw httpError(
      400,
      `Template '${templateId}' not found. Canonical: '${canonicalId}'. Searched:\n- ${tried.join("\n- ")}`
    );
  }

  const raw = fs.readFileSync(found, "utf8");
  let parsed: any;
  try {
    parsed = JSON.parse(raw);
  } catch (e: any) {
    throw httpError(500, `Template '${canonicalId}' JSON parse error at ${found}: ${e?.message || e}`);
  }

  if (!parsed.template_id || typeof parsed.template_id !== "string") {
    throw httpError(500, `Template '${canonicalId}' missing template_id (file: ${found}).`);
  }
  if (!Array.isArray(parsed.slots)) {
    throw httpError(500, `Template '${canonicalId}' slots must be an array (file: ${found}).`);
  }
  if (!parsed.mapping || typeof parsed.mapping !== "object") {
    throw httpError(500, `Template '${canonicalId}' mapping must be an object (file: ${found}).`);
  }
  if (parsed.template_id !== canonicalId) {
    throw httpError(
      500,
      `Template ID mismatch: expected '${canonicalId}', got '${parsed.template_id}' (file: ${found}).`
    );
  }

  return parsed;
}

2) COPY/PASTE: Add a debug endpoint so you can confirm from the browser

Paste this into your main server routes file (where you define other app.get(...) / router.get(...) routes).
This endpoint will tell you what the server can see.

// COPY/PASTE: Debug endpoint to verify template file visibility

import fs from "fs";
import path from "path";
import { loadTemplate } from "./services/templateLoader"; // adjust path if needed

app.get("/api/templates/debug", (_req, res) => {
  const dirs = [
    path.resolve(__dirname, "templates"),
    path.resolve(__dirname, "..", "server", "templates"),
    path.resolve(process.cwd(), "server", "templates"),
    path.resolve(process.cwd(), "templates"),
  ];

  const checks = dirs.map(dir => ({
    dir,
    exists: fs.existsSync(dir),
    files: fs.existsSync(dir) ? fs.readdirSync(dir) : [],
  }));

  res.json({
    cwd: process.cwd(),
    __dirname,
    checks,
  });
});

// Optional: quick template load test
app.get("/api/templates/test/:id", (req, res) => {
  try {
    const t = loadTemplate(req.params.id);
    res.json({ ok: true, template_id: t.template_id, slots: t.slots?.length ?? 0 });
  } catch (e: any) {
    res.status(e?.status || 500).json({ ok: false, error: e?.message || String(e) });
  }
});

3) COPY/PASTE: Make Step 1 return 400/500 correctly (stop hiding errors)

Where Step 1 “Qualify Template” is executed, wrap it like this:

// COPY/PASTE: Proper error handling around loadTemplate in Step 1

try {
  const template = loadTemplate(templateId);
  // continue with qualification...
} catch (e: any) {
  const status = e?.status || 500;
  return res.status(status).json({ error: e?.message || String(e) });
}